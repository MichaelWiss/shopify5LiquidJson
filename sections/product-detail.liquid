<section class="product-detail" data-product-section="{{ section.id }}">
  {% assign summary_wrapper_open = false %}

  <div class="product-detail__inner">
    <aside class="product-detail__sidebar product-sidebar">
      {% for block in section.blocks %}
        {% if block.type != 'summary_row' and summary_wrapper_open %}
          </div>
          {% assign summary_wrapper_open = false %}
        {% endif %}

        {% if block.type == 'summary_row' %}
          {% if summary_wrapper_open == false %}
            <div class="product-summary">
            {% assign summary_wrapper_open = true %}
          {% endif %}
          {% render 'product-summary-row', block: block %}
          {% continue %}
        {% endif %}

        {% case block.type %}
          {% when 'title' %}
            <h1 class="product-title" {{ block.shopify_attributes }}>{{ product.title }}</h1>

          {% when 'price' %}
            <div class="product-price" {{ block.shopify_attributes }} data-product-price aria-live="polite">
              {{ product.selected_or_first_available_variant.price | money }}
            </div>

          {% when 'variant_picker' %}
            <div class="product-form-block" {{ block.shopify_attributes }}>
              {% form 'product', product, class: 'product-form', data-section-id: section.id %}
                {% assign add_to_cart_label = block.settings.button_label | default: 'Add to cart' %}
                {% if product.has_only_default_variant %}
                  <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" data-variant-id-input>
                {% else %}
                  {% assign swatch_options_raw = block.settings.swatch_options | default: '' %}
                  {% assign swatch_options = swatch_options_raw | split: ',' %}

                  {% for option in product.options_with_values %}
                    {% assign option_name_normalized = option.name | strip | downcase %}
                    {% assign is_swatch_option = false %}
                    {% for swatch_option in swatch_options %}
                      {% assign swatch_option_normalized = swatch_option | strip | downcase %}
                      {% if swatch_option_normalized != '' and swatch_option_normalized == option_name_normalized %}
                        {% assign is_swatch_option = true %}
                        {% break %}
                      {% endif %}
                    {% endfor %}

                    {% if is_swatch_option %}
                      {% render 'product-swatch-picker',
                        option: option,
                        swatch_value_colors: block.settings.swatch_value_colors,
                        section_id: section.id
                      %}
                    {% else %}
                      <div class="product-option">
                        <label class="option-label" for="Option-{{ forloop.index0 }}-{{ section.id }}">
                          {{ option.name }}
                        </label>
                        <select
                          id="Option-{{ forloop.index0 }}-{{ section.id }}"
                          class="form-select"
                          name="options[{{ option.name }}]"
                          data-option-position="{{ option.position }}"
                        >
                          {% for value in option.values %}
                            <option value="{{ value }}" {% if option.selected_value == value %}selected{% endif %}>
                              {{ value }}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                    {% endif %}
                  {% endfor %}
                  <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" data-variant-id-input>
                {% endif %}

                <div class="product-option">
                  <label class="option-label" for="Quantity-{{ section.id }}">
                    {{ 'products.product.quantity' | t }}
                  </label>
                  <select
                    id="Quantity-{{ section.id }}"
                    class="form-select"
                    name="quantity"
                  >
                    {% assign quantity_limit = block.settings.quantity_limit | default: 10 %}
                    {% for i in (1..quantity_limit) %}
                      <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                  </select>
                </div>

                <button
                  class="btn product-form__submit"
                  type="submit"
                  data-product-atc
                  data-default-label="{{ add_to_cart_label }}"
                  data-sold-out-label="{{ 'products.product.sold_out' | t }}"
                >
                  {{ add_to_cart_label }}
                </button>
                <p class="product-form__status" data-product-availability data-unavailable-copy="{{ 'products.product.unavailable' | t }}" aria-live="polite"></p>

                {% if block.settings.secondary_button_label != blank %}
                  {% if block.settings.secondary_button_link != blank %}
                    <a class="btn btn-secondary" href="{{ block.settings.secondary_button_link }}">
                      {{ block.settings.secondary_button_label }}
                    </a>
                  {% else %}
                    <button class="btn btn-secondary" type="button">
                      {{ block.settings.secondary_button_label }}
                    </button>
                  {% endif %}
                {% endif %}
              {% endform %}
            </div>

          {% when 'description' %}
            {% if product.description != blank %}
              <div class="product-description" {{ block.shopify_attributes }}>
                {{ product.description }}
              </div>
            {% endif %}

          {% when 'meta' %}
            <dl class="product-meta" {{ block.shopify_attributes }}>
              {% if block.settings.show_vendor and product.vendor != blank %}
                <div class="product-meta-row">
                  <dt class="product-meta-key">{{ 'products.product.vendor' | t }}</dt>
                  <dd class="product-meta-value">{{ product.vendor }}</dd>
                </div>
              {% endif %}
              {% if block.settings.show_sku %}
                {% assign sku_value = product.selected_or_first_available_variant.sku %}
                <div class="product-meta-row product-meta-row--sku" data-product-sku-row {% if sku_value == blank %}hidden{% endif %}>
                  <dt class="product-meta-key">{{ 'products.product.sku' | t }}</dt>
                  <dd class="product-meta-value" data-product-sku>{{ sku_value }}</dd>
                </div>
              {% endif %}
            </dl>
        {% endcase %}
      {% endfor %}
      {% if summary_wrapper_open %}
        </div>
      {% endif %}
    </aside>

    <div class="product-detail__gallery product-images">
      {% assign media_count = product.media.size %}
      {% if media_count > 0 %}
        {% for media in product.media %}
          {% render 'product-gallery-item', media: media %}
        {% endfor %}
      {% endif %}

      {% assign minimum_views = section.settings.minimum_gallery_items | default: 4 %}
      {% if media_count < minimum_views %}
        {% assign placeholders_needed = minimum_views | minus: media_count %}
        {% assign placeholder_styles = "linear-gradient(180deg, #E8DCC8 0%, #D4C8B8 100%)|linear-gradient(180deg, #A4B08C 0%, #7A8450 100%)|linear-gradient(135deg, #8B6B47 0%, #4A3426 100%)|linear-gradient(180deg, #C4932C 0%, #A0584F 100%)" | split: "|" %}
        {% for i in (1..placeholders_needed) %}
          {% assign style_index = forloop.index0 | modulo: placeholder_styles.size %}
          {% assign fallback_style = placeholder_styles[style_index] | strip %}
          {% assign figure_num = media_count | plus: forloop.index %}
          {% render 'product-gallery-item',
            placeholder_style: fallback_style,
            product_title: product.title,
            figure_number: figure_num
          %}
        {% endfor %}
      {% endif %}
    </div>
  </div>
</section>

<script type="application/json" data-product-json="{{ section.id }}">
  {{ product | json }}
</script>

{% schema %}
{
  "name": "Product detail",
  "settings": [
    {
      "type": "range",
      "id": "minimum_gallery_items",
      "label": "Minimum gallery items",
      "min": 1,
      "max": 8,
      "step": 1,
      "default": 4,
      "info": "Placeholder tiles fill the gallery to this count."
    }
  ],
  "blocks": [
    {
      "type": "title",
      "name": "Title",
      "limit": 1
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1
    },
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "button_label",
          "label": "Button label",
          "default": "Add to cart"
        },
        {
          "type": "text",
          "id": "swatch_options",
          "label": "Swatch option names",
          "default": "Stone Color",
          "info": "Comma-separated option names to present as color dots."
        },
        {
          "type": "textarea",
          "id": "swatch_value_colors",
          "label": "Swatch value backgrounds",
          "info": "One per line using the format “Value:background”. Background accepts hex codes or CSS gradients."
        },
        {
          "type": "range",
          "id": "quantity_limit",
          "label": "Maximum quantity in dropdown",
          "min": 1,
          "max": 15,
          "step": 1,
          "default": 10
        },
        {
          "type": "text",
          "id": "secondary_button_label",
          "label": "Secondary button label",
          "default": "Add to trade quote"
        },
        {
          "type": "url",
          "id": "secondary_button_link",
          "label": "Secondary button link"
        }
      ]
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1
    },
    {
      "type": "summary_row",
      "name": "Detail row",
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "default": "Size"
        },
        {
          "type": "text",
          "id": "value",
          "label": "Value",
          "default": "Medium"
        }
      ]
    },
    {
      "type": "meta",
      "name": "Meta",
      "settings": [
        {
          "type": "checkbox",
          "id": "show_vendor",
          "label": "Show vendor",
          "default": true
        },
        {
          "type": "checkbox",
          "id": "show_sku",
          "label": "Show SKU",
          "default": false
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product detail",
      "blocks": [
        { "type": "title" },
        { "type": "price" },
        {
          "type": "summary_row",
          "settings": { "label": "Size", "value": "Medium" }
        },
        {
          "type": "summary_row",
          "settings": { "label": "Orientation", "value": "Vertical" }
        },
        {
          "type": "summary_row",
          "settings": { "label": "Mounting", "value": "Surface" }
        },
        { "type": "variant_picker" },
        { "type": "description" },
        { "type": "meta" }
      ]
    }
  ]
}
{% endschema %}
